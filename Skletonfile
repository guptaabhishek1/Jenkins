pipeline {
    agent any
    
    stages {
       
        
        stage('Parallel Infra Stage') {
            steps {
                parallel(
                        "Build RMQ":
                        {
                            script {
                                try {
                                    //buildRMQ()
                                    echo 'RMQ is UP like'

                            } catch (e) {
                                //getFailnote()
                                
                                //FailureSlackNotification
                                message = "RMQ build Failed"
                                color_code = "#00FF00"
                                username = "Test"
                                slackchannel = "#test"
                                slackNotification(message, color_code, username, slackchannel)
                                
                                error("KK_Build failed because this step isn't implemented...")

                                }
                            }
                        },
                        "Build HZ":
                        {
                            script {
                                try {
                                    //buildHazelCastInfra()
                                    echo "HZ is up"
                            } catch (e) {
                                    //getFailnote()
                                    
                                    //FailureSlackNotification 
                                    message = "HazelCast Build Failed"
                                    color_code = "#00FF00"
                                    username = "Test"
                                    slackchannel = "#test"
                                    slackNotification(message, color_code, username, slackchannel)
                                    
                                    error("KK_Build failed HZ...")

                                    }
                            }

                        }
                ) // End Parallel Infrastructure execution
            }
        }
        
        stage('Send notification') {
            steps {
                script {
                        // Slack Notification
                        message = "Infrastructure Up"
                        color_code = "#00FF00"
                        username = "Test"
                        slackchannel = "#test"
                    }
                    
                    slackNotification(message, color_code, username, slackchannel)
                    //getNotified()
            }

        }
        
        // This is waiting for user Input before staring application deploy stage
        stage('Wait for User Input') {
            steps {
                script {
                    //User_Input_message = input message: 'User input required to Proceed/Abort',
                    //    parameters: [choice(name: 'Click Proceed or Abort', choices: 'no\nyes', description: 'Choose "yes" if you want to deploy this build')]
                    echo "start"
                }
            }
        }
        
        stage('Parallel App stage') {
            steps {
                
                parallel(
                    "buildCAModelScore":
                    {
                        script{
                                // getting status of application
                                env.camresult = buildCAModelScore()
                                echo "${env.camresult}"
                                def buildNumber = "${env.camresult}".split("=")[1].split(",")[0]
                                def buildStatus = "${env.camresult}".split("=")[2].split(",")[0]
                                def buildUrl = "${env.camresult}".split("=")[3].split(",")[0]
                                echo "${buildNumber}"
                                echo "${buildStatus}"
                                echo "${buildUrl}"
                                
                                if (env.userid == ""){
                                    echo "userid is empty"
                                }
                               
                        }
                     },
                    "Build Decision Handler": // Building DH APP
                    {
                        script{
 
                                echo "buildDecisionHandler"
                                //env.decresult = buildDecisionHandler()
                                
                        }
                    },
                    "Build FRE": //Building FRE APP
                    {
                        script{
                            try {
                                echo "buildFraudRulesEngine"
                                //buildFraudRulesEngine()
                            }catch (e) {
                                echo "buildCAModelScore Failed but job needs to be set to success"
                            }
                        }
                     },
                     "USModelScore job": //Building USMS
                     {
                            echo "buildUSModelScore"
                            //buildUSModelScore()
                     }
                ) // End Parallel App

                }
           }
    stage('post-build') {
        steps {
            script { echo "test"
            sendAppStandupFailure()
            
            }
           }
    }
 }
}

def generateIndividualJobFailedHTML(individualjob){
    // Splitting to get buildResult
    buildResult = "${individualjob}".split("=")[1].split(",")[0]
    if (buildResult == 'FAILURE'){
        buildUrl = "${individualjob}".split("=")[2].split("}")[0]
        currentBuild.result = 'UNSTABLE'
        return buildUrl
    }
    
}

def generateAllFailedJobsHTML(){

    def returnString = "<p>Mail body<p>"
    returnString = returnString + generateIndividualJobFailedHTML(env.camresult) + "\n"
    returnString = returnString + generateIndividualJobFailedHTML(env.decresult) + "\n"
    return "${returnString}"
}

def sendAppStandupFailure(){
    echo "Sending failed emails to build user"
    message_body = generateAllFailedJobsHTML()
    echo "${message_body}"
    if (message_body.contains("abhishek")) {
        echo "this is inside failure"
    }
    
    if (message_body.contains("https")) {
        echo "this is inside success"
    }
}
    
// Email Notification function
def getNotified(){

emailext body: '''"""<p>Success!! building INFRA HZ & RMQ: Job \'${JOB_NAME} [${BUILD_NUMBER}]\':</p>
                   <p>Check console output at "<a href="${BUILD_URL}">${JOB_NAME} [${BUILD_NUMBER}]</a>"</p>
                   <p>RabbitMQConsole at "<a href="${ip}"":15672"</a>"   """,''',
           subject: '"Success!! building INFRA HZ & RMQ: Job \'${JOB_NAME} [${BUILD_NUMBER}]\'"',
           to: "${buildUserEmail}"

}

// Email Notification
def getFailnote(){
    // def mailRecipients =  "${BUILD_USER_EMAIL}"
    emailext body: '''"""<p>Failed building INFRA HZ & RMQ: Job \'${JOB_NAME} [${BUILD_NUMBER}]\':</p>
                   <p>Check console output at "<a href="${BUILD_URL}">${JOB_NAME} [${BUILD_NUMBER}]</a>"</p>""",''',
           subject:'"Failed building INFRA HZ & RMQ: Job \'${JOB_NAME} [${BUILD_NUMBER}]\'"',
           to: "${buildUserEmail}"
}

// getSlackNotification
def slackNotification(message, color_code, username, slackchannel)
{
   sh "sh slackStatus.sh \"${message}\" \"${color_code}\" \"${username}\" \"${slackchannel}\""
}

//Failure getSlackNotification
def FailureSlackNotification(){
   echo "${workspace}"
   echo "${pwd}"
   sh "./slackstatus.sh"
}

def buildRMQ() {
       build job: 'TestPipeline2', parameters:
       [
            string(name: 'Enviroment', value: "${env.Enviroment}"),
            string(name: 'Test', value: "${env.Test}"),
            string(name: 'userid', value: "${env.userid}")
       ]

}

def buildHazelCastInfra() {
       build job: 'TestPipeline3', parameters:
       [
            string(name: 'Enviroment', value: "${env.Enviroment}"),
            string(name: 'Test', value: "${env.Test}"),
            string(name: 'userid', value: "${env.userid}")
       ]

}

def buildCAModelScore() {
       
       build_run = build job: 'TestPipeline1', propagate: false, parameters:
           [
                string(name: 'Deployment_Location', value: "${env.Enviroment},${env.AZ}"),
                string(name: 'TargetCluster_Deployment', value: "${env.TargetCluster_Deployment}"),
                string(name: 'Cluster_Type', value: "${env.Cluster_Type}"),
                string(name: 'AZ', value: "${env.MultiAZ}")
           ]

       return [buildNumber: "${build_run.number}", buildStatus:"${build_run.result}", buildUrl:"${build_run.absoluteUrl}"]
}

def buildDecisionHandler() {
       
       build_run = build job: 'TestPipeline1', propagate: false, parameters:
           [
                string(name: 'Deployment_Location', value: "${env.Enviroment},${env.AZ}"),
                string(name: 'TargetCluster_Deployment', value: "${env.TargetCluster_Deployment}"),
                string(name: 'Cluster_Type', value: "${env.Cluster_Type}"),
                string(name: 'AZ', value: "${env.MultiAZ}")
           ]

       return [buildNumber: "${build_run.number}", buildStatus:"${build_run.result}", buildUrl:"${build_run.absoluteUrl}"]

}
