import hudson.model.User
import groovy.json.JsonSlurper
import groovy.json.JsonOutput
pipeline 
{
  agent any
  stages {        
    stage('Serial') {
      when {
                expression { params.Enviroment == 'dev' }
      }
      steps{
        script{
          println "Serial Stage"
          
          //parameters(env.AZ, env.TargetCluster_Deployment)
          //echo "${env.Tst}"
          //Tst1 = "${env.MultiAZ}".split("-")[1].toLowerCase().capitalize()
          //echo "${Tst1}"
          
          durationInSeconds = (params.HoursToRun.toInteger() * 3600).toString()
          env.halfDurationInSeconds = (durationInSeconds.toInteger().div(2)).toString()
          //echo "${halfDurationInSeconds}"
          //echo "${durationInSeconds}"
          //sleep(halfDurationInSeconds.toInteger())
          
          buildCAModelScore()
        
        }
      }
    }
    stage('ParallelMultiAZ') {
      when {
            expression { params.Enviroment == 'qa' }
      }
      steps{
        parallel(
          "MultiAZ1": {
            script{
              println "Parallel Stage1"
              //parameters1("${env.AZ}", "${env.TargetCluster_Deployment}")
              parameters1(env.AZ, env.TargetCluster_Deployment)
              echo "${env.Tst}"
              echo "${env.Region}"
              echo "${env.AZ1}"
            }
          },
          "MUltiAz2": {
            println "Parallel Stage2"
            sleep(30)
            //parameters1("${env.MultiAZ}", "${env.TargetCluster_Deployment}")
            parameters1(env.MultiAZ, env.TargetCluster_Deployment)
            echo "${env.Tst}"
            echo "${env.Region}"
            echo "${env.AZ1}"
          },
      )
      }
    }
  }
}

def parameters1(AZ, Deploy){
  env.Tst = "${AZ}".split("-")[1].toLowerCase().capitalize()
  env.Region = "${Deploy[0..-2]}"
  env.AZ1 = "this is test"
  
  }
  
  def buildCAModelScore() {
      seconds_to_run = "${env.halfDurationInSeconds.toInteger()}"
      build_run = build job: 'TestPipeline1', propagate: false, quietPeriod: "${seconds_to_run}" as int, wait:false, 
      parameters:
      [
          string(name: 'Deployment_Location', value: "${env.Enviroment},${env.AZ}"),
                string(name: 'TargetCluster_Deployment', value: "${env.TargetCluster_Deployment}"),
                string(name: 'Cluster_Type', value: "${env.Cluster_Type}"),
                string(name: 'AZ', value: "${env.MultiAZ}")
      ]
   }
