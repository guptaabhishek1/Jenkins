node{

  def ApiUrl = "https://my-json-server.typicode.com/user/repo/posts/1"
      
  stage('FetchApiFile') {
    echo 'Calling API to get event details contents'
    sh "curl ${ApiUrl} > /tmp/ApiUrl.txt"
    sh """
    cat >/tmp/ApiUrl1.txt <<EOF
MapName|us-east-1|us-west-1
Event|150000 per/min|
Agg Event|50000 per/min|
Mer Event|5000 per/min|
EOF
    """
    def Event = sh(script:'cat /tmp/ApiUrl1.txt |grep -w "Event" |head -1 |cut -d "|" -f2 |cut -d " " -f1 ', returnStdout: true).trim()
    sh """
      if [ ${Event} -gt "150000" ]
      then
        currentBuild.result = 'SUCCESS'
        echo "Sending sucess status message to slack"
      else
        echo 'Such build, wow!'
        currentBuild='FAILED'
        echo "Sending failed status message to slack"
      fi
    """
        
  }
  
  stage('Slack Status'){
    echo "${currentBuild.result}"
    checkout scm
    sh 'git rev-parse --verify HEAD > commit'
    def commitHash = readFile('commit').trim()
    
    def jobParametersMessage = "\n" + "\nIntegrationTestVersion: " + commitHash + "\nJOB_BASE_NAME: " + env.JOB_BASE_NAME + \
      "\nEnvironment: " + params.Environment

    println "$jobParametersMessage"
      
  
  }
}
